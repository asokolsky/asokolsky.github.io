---
title: Keeping an Eye on your IaC
tags: aws
---

Business problem to solve: Monitor our AWS IaC for potential changes outside of the IaC workflows.

Context: an AWS object is considered to be a part of our IaC if it has a proper tag `managed-by` set.

## False Start

I first hoped to use [CloudTrail](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-user-guide.html) Lake [event data store](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/query-event-data-store.html) with [event enrichment](https://aws.amazon.com/blogs/mt/announcing-aws-cloudtrail-lake-now-supports-event-enrichment-add-business-context-to-your-aws-activity-logs/) enabled so that the event responsible for the change already had a proper tag (if any) attached.  This did not really work.

## Solution

[This article](https://aws.amazon.com/blogs/mt/how-to-use-aws-config-and-cloudtrail-to-find-who-made-changes-to-a-resource/) outlines the solution.

It all starts with the [AWS Config](https://docs.aws.amazon.com/config/latest/developerguide/WhatIsConfig.html) with the recording on.  Check the AWS Console Config Settings section. We will monitor changes to [Configuration Item](https://docs.aws.amazon.com/config/latest/developerguide/config-item-table.html), or CI for short.  CIs support a [wide range](https://docs.aws.amazon.com/config/latest/developerguide/resource-config-reference.html) of AWS objects.

We add an [Event Bridge rule](https://docs.aws.amazon.com/eventbridge/latest/userguide/eb-rules.html) to to pass a CI change event to an SQS queue.  My first thought was to handle this change event in lambda, only to realize that the event itself does not carry enough information, hence the need to look for the corresponding change events in the Cloud Trail.

An SQS queue with DLQ ensures retries and ultimately scalability.

A lambda is attached to the SQS queue and does the bulk of the work:
1. Lambda consumes the the CI change event from the queue,
2. calculates the timeframe for the lookup of the corresponding events in the CLoudTrail - expected to be within 90 seconds.
3. Performs the CloudTrail lookup - we are interested in the user identity first and foremost.
4. Checks the tags of the object affected
4. Finally publishes message to the predefined [SNS topic](https://docs.aws.amazon.com/sns/latest/dg/welcome.html) outlining who changed which IaC object and when.

One can consume SNS messages via e-mail or other means such as Slack messaging.
